# to be called by another makefile
# e.g. make -C simple -f ../makefile_local.gnu PREFIX=simple clean

ifeq ($(VC_AVAILABLE), yes)
all : $(PREFIX)_simd_class_vectorization.x $(PREFIX)_reference.x $(PREFIX)_explicit_vectorization.x $(PREFIX)_enhanced_explicit_vectorization.x $(PREFIX)_manual_vectorization.x
	rm -f $(PREFIX)_*.o
else
all : $(PREFIX)_reference.x $(PREFIX)_explicit_vectorization.x $(PREFIX)_enhanced_explicit_vectorization.x $(PREFIX)_manual_vectorization.x
	rm -f $(PREFIX)_*.o
endif
	
$(PREFIX)_reference.x : $(PREFIX)_kernel_reference.o
	$(CXX) $(CXXFLAGS) -o $@_benchmark.o -c $(SRC_DIR)/common/benchmark.cpp
	$(LD) -o $@ $? $@_benchmark.o $(LDFLAGS)

$(PREFIX)_explicit_vectorization.x : $(PREFIX)_kernel_explicit_vectorization.o $(PREFIX)_kernel_reference.o
	$(CXX) $(CXXFLAGS) -DEXPLICIT_VECTORIZATION -o $@_benchmark.o -c $(SRC_DIR)/common/benchmark.cpp
	$(LD) -o $@ $? $@_benchmark.o $(LDFLAGS)

$(PREFIX)_enhanced_explicit_vectorization.x : $(PREFIX)_kernel_enhanced_explicit_vectorization.o $(PREFIX)_kernel_reference.o
	$(CXX) $(CXXFLAGS) -DENHANCED_EXPLICIT_VECTORIZATION -o $@_benchmark.o -c $(SRC_DIR)/common/benchmark.cpp
	$(LD) -o $@ $? $@_benchmark.o $(LDFLAGS)

$(PREFIX)_manual_vectorization.x : $(PREFIX)_kernel_manual_vectorization.o $(PREFIX)_kernel_reference.o
	$(CXX) $(CXXFLAGS) -DMANUAL_VECTORIZATION -o $@_benchmark.o -c $(SRC_DIR)/common/benchmark.cpp
	$(LD) -o $@ $? $@_benchmark.o $(LDFLAGS)

$(PREFIX)_simd_class_vectorization.x : $(PREFIX)_kernel_simd_class_vectorization.o $(PREFIX)_kernel_reference.o
	$(CXX) $(CXXFLAGS) -DSIMD_CLASS_VECTORIZATION -I$(VC_ROOT)/include -o $@_benchmark.o -c $(SRC_DIR)/common/benchmark.cpp
ifeq ($(PLATFORM), mic)
	$(LD) -o $@ $? $@_benchmark.o $(LDFLAGS) $(VC_ROOT)/lib/libVc_MIC.a
else
	$(LD) -o $@ $? $@_benchmark.o $(LDFLAGS) $(VC_ROOT)/lib/libVc.a
endif


$(PREFIX)_kernel_reference.o : kernel_reference.cpp
	$(CXX) $(CXXFLAGS) -o $@ -c $<

$(PREFIX)_kernel_explicit_vectorization.o : kernel_explicit_vectorization.cpp
	$(CXX) $(CXXFLAGS) -DEXPLICIT_VECTORIZATION -o $@ -c $<

$(PREFIX)_kernel_enhanced_explicit_vectorization.o : kernel_enhanced_explicit_vectorization.cpp
	$(CXX) $(CXXFLAGS) -DENHANCED_EXPLICIT_VECTORIZATION -o $@ -c $<

$(PREFIX)_kernel_manual_vectorization.o : kernel_manual_vectorization.cpp
	$(CXX) $(CXXFLAGS) -DMANUAL_VECTORIZATION -o $@ -c $<

$(PREFIX)_kernel_simd_class_vectorization.o : kernel_simd_class_vectorization.cpp
	$(CXX) $(CXXFLAGS) -DSIMD_CLASS_VECTORIZATION -I$(VC_ROOT)/include -o $@ -c $<

clean :
	rm -f *.o *.x
